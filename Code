#include <stdlib.h>
#include <string.h>

void solveNQueensHelper(int n, int row, int* cols, int* diag1, int* diag2,
                        char** board, char*** result, int* returnSize, int** returnColumnSizes) {
    if (row == n) {
        // Found a solution
        result[*returnSize] = (char**)malloc(n * sizeof(char*));
        for (int i = 0; i < n; i++) {
            result[*returnSize][i] = strdup(board[i]);
        }
        (*returnColumnSizes)[*returnSize] = n;
        (*returnSize)++;
        return;
    }

    for (int c = 0; c < n; c++) {
        if (cols[c] || diag1[row + c] || diag2[row - c + n - 1])
            continue;

        // Place queen
        cols[c] = diag1[row + c] = diag2[row - c + n - 1] = 1;
        board[row][c] = 'Q';

        solveNQueensHelper(n, row + 1, cols, diag1, diag2, board, result, returnSize, returnColumnSizes);

        // Backtrack
        cols[c] = diag1[row + c] = diag2[row - c + n - 1] = 0;
        board[row][c] = '.';
    }
}

char*** solveNQueens(int n, int* returnSize, int** returnColumnSizes) {
    *returnSize = 0;
    int maxSolutions = 1000;  // upper bound for n <= 9
    char*** result = (char***)malloc(maxSolutions * sizeof(char**));
    *returnColumnSizes = (int*)malloc(maxSolutions * sizeof(int));

    char** board = (char**)malloc(n * sizeof(char*));
    for (int i = 0; i < n; i++) {
        board[i] = (char*)malloc((n + 1) * sizeof(char));
        memset(board[i], '.', n);
        board[i][n] = '\0';
    }

    int* cols = (int*)calloc(n, sizeof(int));
    int* diag1 = (int*)calloc(2 * n - 1, sizeof(int));
    int* diag2 = (int*)calloc(2 * n - 1, sizeof(int));

    solveNQueensHelper(n, 0, cols, diag1, diag2, board, result, returnSize, returnColumnSizes);

    for (int i = 0; i < n; i++) free(board[i]);
    free(board);
    free(cols);
    free(diag1);
    free(diag2);

    return result;
}
